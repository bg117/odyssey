.extern exception_handler
.global interrupt_intermediary

#define INTSTUB_NOERR(i) \
  .global interrupt_stub_##i; \
  interrupt_stub_##i: \
    push $0; \
    push $##i; \
    jmp interrupt_intermediary;

#define INTSTUB_ERR(i) \
  .global interrupt_stub_##i; \
  interrupt_stub_##i: \
    push $##i; \
    jmp interrupt_intermediary;

interrupt_intermediary:
  push %rax
  push %rbx
  push %rcx
  push %rdx
  push %rsp
  push %rbp
  push %rsi
  push %rdi
  push %r8
  push %r9
  push %r10
  push %r11
  push %r12
  push %r13
  push %r14
  push %r15

  mov %cr0, %rax
  push %rax
  mov %cr2, %rax
  push %rax
  mov %cr3, %rax
  push %rax
  mov %cr4, %rax
  push %rax

  xor %rax, %rax
  mov %ds, %ax

  mov $0x30, %ax
  mov %ax, %ds
  mov %ax, %es
  mov %ax, %fs
  mov %ax, %gs

  mov %rsp,%rdi // pointer to interrupt info
  
  call exception_handler

  pop %rax
  pop %rax
  pop %rax
  pop %rax

  pop %r15
  pop %r14
  pop %r13
  pop %r12
  pop %r11
  pop %r10
  pop %r9
  pop %r8
  pop %rdi
  pop %rsi
  pop %rbp
  pop %rsp
  pop %rdx
  pop %rcx
  pop %rbx
  pop %rax
  add $0x10, %rsp
  iretq

INTSTUB_NOERR(0)
INTSTUB_NOERR(1)
INTSTUB_NOERR(2)
INTSTUB_NOERR(3)
INTSTUB_NOERR(4)
INTSTUB_NOERR(5)
INTSTUB_NOERR(6)
INTSTUB_NOERR(7)
INTSTUB_ERR(8)
INTSTUB_NOERR(9)
INTSTUB_ERR(10)
INTSTUB_ERR(11)
INTSTUB_ERR(12)
INTSTUB_ERR(13)
INTSTUB_ERR(14)
INTSTUB_NOERR(15)
INTSTUB_NOERR(16)
INTSTUB_ERR(17)
INTSTUB_NOERR(18)
INTSTUB_NOERR(19)
INTSTUB_NOERR(20)
INTSTUB_ERR(21)
INTSTUB_NOERR(22)
INTSTUB_NOERR(23)
INTSTUB_NOERR(24)
INTSTUB_NOERR(25)
INTSTUB_NOERR(26)
INTSTUB_NOERR(27)
INTSTUB_NOERR(28)
INTSTUB_ERR(29)
INTSTUB_ERR(30)
INTSTUB_NOERR(31)
INTSTUB_NOERR(32)
INTSTUB_NOERR(33)
INTSTUB_NOERR(34)
INTSTUB_NOERR(35)
INTSTUB_NOERR(36)
INTSTUB_NOERR(37)
INTSTUB_NOERR(38)
INTSTUB_NOERR(39)
INTSTUB_NOERR(40)
INTSTUB_NOERR(41)
INTSTUB_NOERR(42)
INTSTUB_NOERR(43)
INTSTUB_NOERR(44)
INTSTUB_NOERR(45)
INTSTUB_NOERR(46)
INTSTUB_NOERR(47)
INTSTUB_NOERR(48)
INTSTUB_NOERR(49)
INTSTUB_NOERR(50)
INTSTUB_NOERR(51)
INTSTUB_NOERR(52)
INTSTUB_NOERR(53)
INTSTUB_NOERR(54)
INTSTUB_NOERR(55)
INTSTUB_NOERR(56)
INTSTUB_NOERR(57)
INTSTUB_NOERR(58)
INTSTUB_NOERR(59)
INTSTUB_NOERR(60)
INTSTUB_NOERR(61)
INTSTUB_NOERR(62)
INTSTUB_NOERR(63)
INTSTUB_NOERR(64)
INTSTUB_NOERR(65)
INTSTUB_NOERR(66)
INTSTUB_NOERR(67)
INTSTUB_NOERR(68)
INTSTUB_NOERR(69)
INTSTUB_NOERR(70)
INTSTUB_NOERR(71)
INTSTUB_NOERR(72)
INTSTUB_NOERR(73)
INTSTUB_NOERR(74)
INTSTUB_NOERR(75)
INTSTUB_NOERR(76)
INTSTUB_NOERR(77)
INTSTUB_NOERR(78)
INTSTUB_NOERR(79)
INTSTUB_NOERR(80)
INTSTUB_NOERR(81)
INTSTUB_NOERR(82)
INTSTUB_NOERR(83)
INTSTUB_NOERR(84)
INTSTUB_NOERR(85)
INTSTUB_NOERR(86)
INTSTUB_NOERR(87)
INTSTUB_NOERR(88)
INTSTUB_NOERR(89)
INTSTUB_NOERR(90)
INTSTUB_NOERR(91)
INTSTUB_NOERR(92)
INTSTUB_NOERR(93)
INTSTUB_NOERR(94)
INTSTUB_NOERR(95)
INTSTUB_NOERR(96)
INTSTUB_NOERR(97)
INTSTUB_NOERR(98)
INTSTUB_NOERR(99)
INTSTUB_NOERR(100)
INTSTUB_NOERR(101)
INTSTUB_NOERR(102)
INTSTUB_NOERR(103)
INTSTUB_NOERR(104)
INTSTUB_NOERR(105)
INTSTUB_NOERR(106)
INTSTUB_NOERR(107)
INTSTUB_NOERR(108)
INTSTUB_NOERR(109)
INTSTUB_NOERR(110)
INTSTUB_NOERR(111)
INTSTUB_NOERR(112)
INTSTUB_NOERR(113)
INTSTUB_NOERR(114)
INTSTUB_NOERR(115)
INTSTUB_NOERR(116)
INTSTUB_NOERR(117)
INTSTUB_NOERR(118)
INTSTUB_NOERR(119)
INTSTUB_NOERR(120)
INTSTUB_NOERR(121)
INTSTUB_NOERR(122)
INTSTUB_NOERR(123)
INTSTUB_NOERR(124)
INTSTUB_NOERR(125)
INTSTUB_NOERR(126)
INTSTUB_NOERR(127)
INTSTUB_NOERR(128)
INTSTUB_NOERR(129)
INTSTUB_NOERR(130)
INTSTUB_NOERR(131)
INTSTUB_NOERR(132)
INTSTUB_NOERR(133)
INTSTUB_NOERR(134)
INTSTUB_NOERR(135)
INTSTUB_NOERR(136)
INTSTUB_NOERR(137)
INTSTUB_NOERR(138)
INTSTUB_NOERR(139)
INTSTUB_NOERR(140)
INTSTUB_NOERR(141)
INTSTUB_NOERR(142)
INTSTUB_NOERR(143)
INTSTUB_NOERR(144)
INTSTUB_NOERR(145)
INTSTUB_NOERR(146)
INTSTUB_NOERR(147)
INTSTUB_NOERR(148)
INTSTUB_NOERR(149)
INTSTUB_NOERR(150)
INTSTUB_NOERR(151)
INTSTUB_NOERR(152)
INTSTUB_NOERR(153)
INTSTUB_NOERR(154)
INTSTUB_NOERR(155)
INTSTUB_NOERR(156)
INTSTUB_NOERR(157)
INTSTUB_NOERR(158)
INTSTUB_NOERR(159)
INTSTUB_NOERR(160)
INTSTUB_NOERR(161)
INTSTUB_NOERR(162)
INTSTUB_NOERR(163)
INTSTUB_NOERR(164)
INTSTUB_NOERR(165)
INTSTUB_NOERR(166)
INTSTUB_NOERR(167)
INTSTUB_NOERR(168)
INTSTUB_NOERR(169)
INTSTUB_NOERR(170)
INTSTUB_NOERR(171)
INTSTUB_NOERR(172)
INTSTUB_NOERR(173)
INTSTUB_NOERR(174)
INTSTUB_NOERR(175)
INTSTUB_NOERR(176)
INTSTUB_NOERR(177)
INTSTUB_NOERR(178)
INTSTUB_NOERR(179)
INTSTUB_NOERR(180)
INTSTUB_NOERR(181)
INTSTUB_NOERR(182)
INTSTUB_NOERR(183)
INTSTUB_NOERR(184)
INTSTUB_NOERR(185)
INTSTUB_NOERR(186)
INTSTUB_NOERR(187)
INTSTUB_NOERR(188)
INTSTUB_NOERR(189)
INTSTUB_NOERR(190)
INTSTUB_NOERR(191)
INTSTUB_NOERR(192)
INTSTUB_NOERR(193)
INTSTUB_NOERR(194)
INTSTUB_NOERR(195)
INTSTUB_NOERR(196)
INTSTUB_NOERR(197)
INTSTUB_NOERR(198)
INTSTUB_NOERR(199)
INTSTUB_NOERR(200)
INTSTUB_NOERR(201)
INTSTUB_NOERR(202)
INTSTUB_NOERR(203)
INTSTUB_NOERR(204)
INTSTUB_NOERR(205)
INTSTUB_NOERR(206)
INTSTUB_NOERR(207)
INTSTUB_NOERR(208)
INTSTUB_NOERR(209)
INTSTUB_NOERR(210)
INTSTUB_NOERR(211)
INTSTUB_NOERR(212)
INTSTUB_NOERR(213)
INTSTUB_NOERR(214)
INTSTUB_NOERR(215)
INTSTUB_NOERR(216)
INTSTUB_NOERR(217)
INTSTUB_NOERR(218)
INTSTUB_NOERR(219)
INTSTUB_NOERR(220)
INTSTUB_NOERR(221)
INTSTUB_NOERR(222)
INTSTUB_NOERR(223)
INTSTUB_NOERR(224)
INTSTUB_NOERR(225)
INTSTUB_NOERR(226)
INTSTUB_NOERR(227)
INTSTUB_NOERR(228)
INTSTUB_NOERR(229)
INTSTUB_NOERR(230)
INTSTUB_NOERR(231)
INTSTUB_NOERR(232)
INTSTUB_NOERR(233)
INTSTUB_NOERR(234)
INTSTUB_NOERR(235)
INTSTUB_NOERR(236)
INTSTUB_NOERR(237)
INTSTUB_NOERR(238)
INTSTUB_NOERR(239)
INTSTUB_NOERR(240)
INTSTUB_NOERR(241)
INTSTUB_NOERR(242)
INTSTUB_NOERR(243)
INTSTUB_NOERR(244)
INTSTUB_NOERR(245)
INTSTUB_NOERR(246)
INTSTUB_NOERR(247)
INTSTUB_NOERR(248)
INTSTUB_NOERR(249)
INTSTUB_NOERR(250)
INTSTUB_NOERR(251)
INTSTUB_NOERR(252)
INTSTUB_NOERR(253)
INTSTUB_NOERR(254)
INTSTUB_NOERR(255)
