#include "low_level/isr.hpp"

#include "misc/log.hpp"

namespace
{
low_level::isr::handler handlers[256] = {};
low_level::idt::entry *idt;

void set_idt_entry_fields(uint8_t vector, void (*stub)(), uint16_t code_segment,
                          uint8_t attributes);
} // namespace

extern "C" void exception_handler(low_level::isr::interrupt_info *int_info)
{
  if (handlers[int_info->vector] != nullptr)
  {
    handlers[int_info->vector](int_info);
  }
}

#pragma region Stub declarations
extern "C" void interrupt_stub_0();
extern "C" void interrupt_stub_1();
extern "C" void interrupt_stub_2();
extern "C" void interrupt_stub_3();
extern "C" void interrupt_stub_4();
extern "C" void interrupt_stub_5();
extern "C" void interrupt_stub_6();
extern "C" void interrupt_stub_7();
extern "C" void interrupt_stub_8();
extern "C" void interrupt_stub_9();
extern "C" void interrupt_stub_10();
extern "C" void interrupt_stub_11();
extern "C" void interrupt_stub_12();
extern "C" void interrupt_stub_13();
extern "C" void interrupt_stub_14();
extern "C" void interrupt_stub_15();
extern "C" void interrupt_stub_16();
extern "C" void interrupt_stub_17();
extern "C" void interrupt_stub_18();
extern "C" void interrupt_stub_19();
extern "C" void interrupt_stub_20();
extern "C" void interrupt_stub_21();
extern "C" void interrupt_stub_22();
extern "C" void interrupt_stub_23();
extern "C" void interrupt_stub_24();
extern "C" void interrupt_stub_25();
extern "C" void interrupt_stub_26();
extern "C" void interrupt_stub_27();
extern "C" void interrupt_stub_28();
extern "C" void interrupt_stub_29();
extern "C" void interrupt_stub_30();
extern "C" void interrupt_stub_31();
extern "C" void interrupt_stub_32();
extern "C" void interrupt_stub_33();
extern "C" void interrupt_stub_34();
extern "C" void interrupt_stub_35();
extern "C" void interrupt_stub_36();
extern "C" void interrupt_stub_37();
extern "C" void interrupt_stub_38();
extern "C" void interrupt_stub_39();
extern "C" void interrupt_stub_40();
extern "C" void interrupt_stub_41();
extern "C" void interrupt_stub_42();
extern "C" void interrupt_stub_43();
extern "C" void interrupt_stub_44();
extern "C" void interrupt_stub_45();
extern "C" void interrupt_stub_46();
extern "C" void interrupt_stub_47();
extern "C" void interrupt_stub_48();
extern "C" void interrupt_stub_49();
extern "C" void interrupt_stub_50();
extern "C" void interrupt_stub_51();
extern "C" void interrupt_stub_52();
extern "C" void interrupt_stub_53();
extern "C" void interrupt_stub_54();
extern "C" void interrupt_stub_55();
extern "C" void interrupt_stub_56();
extern "C" void interrupt_stub_57();
extern "C" void interrupt_stub_58();
extern "C" void interrupt_stub_59();
extern "C" void interrupt_stub_60();
extern "C" void interrupt_stub_61();
extern "C" void interrupt_stub_62();
extern "C" void interrupt_stub_63();
extern "C" void interrupt_stub_64();
extern "C" void interrupt_stub_65();
extern "C" void interrupt_stub_66();
extern "C" void interrupt_stub_67();
extern "C" void interrupt_stub_68();
extern "C" void interrupt_stub_69();
extern "C" void interrupt_stub_70();
extern "C" void interrupt_stub_71();
extern "C" void interrupt_stub_72();
extern "C" void interrupt_stub_73();
extern "C" void interrupt_stub_74();
extern "C" void interrupt_stub_75();
extern "C" void interrupt_stub_76();
extern "C" void interrupt_stub_77();
extern "C" void interrupt_stub_78();
extern "C" void interrupt_stub_79();
extern "C" void interrupt_stub_80();
extern "C" void interrupt_stub_81();
extern "C" void interrupt_stub_82();
extern "C" void interrupt_stub_83();
extern "C" void interrupt_stub_84();
extern "C" void interrupt_stub_85();
extern "C" void interrupt_stub_86();
extern "C" void interrupt_stub_87();
extern "C" void interrupt_stub_88();
extern "C" void interrupt_stub_89();
extern "C" void interrupt_stub_90();
extern "C" void interrupt_stub_91();
extern "C" void interrupt_stub_92();
extern "C" void interrupt_stub_93();
extern "C" void interrupt_stub_94();
extern "C" void interrupt_stub_95();
extern "C" void interrupt_stub_96();
extern "C" void interrupt_stub_97();
extern "C" void interrupt_stub_98();
extern "C" void interrupt_stub_99();
extern "C" void interrupt_stub_100();
extern "C" void interrupt_stub_101();
extern "C" void interrupt_stub_102();
extern "C" void interrupt_stub_103();
extern "C" void interrupt_stub_104();
extern "C" void interrupt_stub_105();
extern "C" void interrupt_stub_106();
extern "C" void interrupt_stub_107();
extern "C" void interrupt_stub_108();
extern "C" void interrupt_stub_109();
extern "C" void interrupt_stub_110();
extern "C" void interrupt_stub_111();
extern "C" void interrupt_stub_112();
extern "C" void interrupt_stub_113();
extern "C" void interrupt_stub_114();
extern "C" void interrupt_stub_115();
extern "C" void interrupt_stub_116();
extern "C" void interrupt_stub_117();
extern "C" void interrupt_stub_118();
extern "C" void interrupt_stub_119();
extern "C" void interrupt_stub_120();
extern "C" void interrupt_stub_121();
extern "C" void interrupt_stub_122();
extern "C" void interrupt_stub_123();
extern "C" void interrupt_stub_124();
extern "C" void interrupt_stub_125();
extern "C" void interrupt_stub_126();
extern "C" void interrupt_stub_127();
extern "C" void interrupt_stub_128();
extern "C" void interrupt_stub_129();
extern "C" void interrupt_stub_130();
extern "C" void interrupt_stub_131();
extern "C" void interrupt_stub_132();
extern "C" void interrupt_stub_133();
extern "C" void interrupt_stub_134();
extern "C" void interrupt_stub_135();
extern "C" void interrupt_stub_136();
extern "C" void interrupt_stub_137();
extern "C" void interrupt_stub_138();
extern "C" void interrupt_stub_139();
extern "C" void interrupt_stub_140();
extern "C" void interrupt_stub_141();
extern "C" void interrupt_stub_142();
extern "C" void interrupt_stub_143();
extern "C" void interrupt_stub_144();
extern "C" void interrupt_stub_145();
extern "C" void interrupt_stub_146();
extern "C" void interrupt_stub_147();
extern "C" void interrupt_stub_148();
extern "C" void interrupt_stub_149();
extern "C" void interrupt_stub_150();
extern "C" void interrupt_stub_151();
extern "C" void interrupt_stub_152();
extern "C" void interrupt_stub_153();
extern "C" void interrupt_stub_154();
extern "C" void interrupt_stub_155();
extern "C" void interrupt_stub_156();
extern "C" void interrupt_stub_157();
extern "C" void interrupt_stub_158();
extern "C" void interrupt_stub_159();
extern "C" void interrupt_stub_160();
extern "C" void interrupt_stub_161();
extern "C" void interrupt_stub_162();
extern "C" void interrupt_stub_163();
extern "C" void interrupt_stub_164();
extern "C" void interrupt_stub_165();
extern "C" void interrupt_stub_166();
extern "C" void interrupt_stub_167();
extern "C" void interrupt_stub_168();
extern "C" void interrupt_stub_169();
extern "C" void interrupt_stub_170();
extern "C" void interrupt_stub_171();
extern "C" void interrupt_stub_172();
extern "C" void interrupt_stub_173();
extern "C" void interrupt_stub_174();
extern "C" void interrupt_stub_175();
extern "C" void interrupt_stub_176();
extern "C" void interrupt_stub_177();
extern "C" void interrupt_stub_178();
extern "C" void interrupt_stub_179();
extern "C" void interrupt_stub_180();
extern "C" void interrupt_stub_181();
extern "C" void interrupt_stub_182();
extern "C" void interrupt_stub_183();
extern "C" void interrupt_stub_184();
extern "C" void interrupt_stub_185();
extern "C" void interrupt_stub_186();
extern "C" void interrupt_stub_187();
extern "C" void interrupt_stub_188();
extern "C" void interrupt_stub_189();
extern "C" void interrupt_stub_190();
extern "C" void interrupt_stub_191();
extern "C" void interrupt_stub_192();
extern "C" void interrupt_stub_193();
extern "C" void interrupt_stub_194();
extern "C" void interrupt_stub_195();
extern "C" void interrupt_stub_196();
extern "C" void interrupt_stub_197();
extern "C" void interrupt_stub_198();
extern "C" void interrupt_stub_199();
extern "C" void interrupt_stub_200();
extern "C" void interrupt_stub_201();
extern "C" void interrupt_stub_202();
extern "C" void interrupt_stub_203();
extern "C" void interrupt_stub_204();
extern "C" void interrupt_stub_205();
extern "C" void interrupt_stub_206();
extern "C" void interrupt_stub_207();
extern "C" void interrupt_stub_208();
extern "C" void interrupt_stub_209();
extern "C" void interrupt_stub_210();
extern "C" void interrupt_stub_211();
extern "C" void interrupt_stub_212();
extern "C" void interrupt_stub_213();
extern "C" void interrupt_stub_214();
extern "C" void interrupt_stub_215();
extern "C" void interrupt_stub_216();
extern "C" void interrupt_stub_217();
extern "C" void interrupt_stub_218();
extern "C" void interrupt_stub_219();
extern "C" void interrupt_stub_220();
extern "C" void interrupt_stub_221();
extern "C" void interrupt_stub_222();
extern "C" void interrupt_stub_223();
extern "C" void interrupt_stub_224();
extern "C" void interrupt_stub_225();
extern "C" void interrupt_stub_226();
extern "C" void interrupt_stub_227();
extern "C" void interrupt_stub_228();
extern "C" void interrupt_stub_229();
extern "C" void interrupt_stub_230();
extern "C" void interrupt_stub_231();
extern "C" void interrupt_stub_232();
extern "C" void interrupt_stub_233();
extern "C" void interrupt_stub_234();
extern "C" void interrupt_stub_235();
extern "C" void interrupt_stub_236();
extern "C" void interrupt_stub_237();
extern "C" void interrupt_stub_238();
extern "C" void interrupt_stub_239();
extern "C" void interrupt_stub_240();
extern "C" void interrupt_stub_241();
extern "C" void interrupt_stub_242();
extern "C" void interrupt_stub_243();
extern "C" void interrupt_stub_244();
extern "C" void interrupt_stub_245();
extern "C" void interrupt_stub_246();
extern "C" void interrupt_stub_247();
extern "C" void interrupt_stub_248();
extern "C" void interrupt_stub_249();
extern "C" void interrupt_stub_250();
extern "C" void interrupt_stub_251();
extern "C" void interrupt_stub_252();
extern "C" void interrupt_stub_253();
extern "C" void interrupt_stub_254();
extern "C" void interrupt_stub_255();
#pragma endregion

namespace low_level
{
namespace isr
{
void initialize(idt::entry idt[256])
{
  ::idt = idt;
  set_idt_entry_fields(0, interrupt_stub_0, 0x28, 0x8E);
  set_idt_entry_fields(1, interrupt_stub_1, 0x28, 0x8E);
  set_idt_entry_fields(2, interrupt_stub_2, 0x28, 0x8E);
  set_idt_entry_fields(3, interrupt_stub_3, 0x28, 0x8F);
  set_idt_entry_fields(4, interrupt_stub_4, 0x28, 0x8F);
  set_idt_entry_fields(5, interrupt_stub_5, 0x28, 0x8E);
  set_idt_entry_fields(6, interrupt_stub_6, 0x28, 0x8E);
  set_idt_entry_fields(7, interrupt_stub_7, 0x28, 0x8E);
  set_idt_entry_fields(8, interrupt_stub_8, 0x28, 0x8E);
  set_idt_entry_fields(9, interrupt_stub_9, 0x28, 0x8E);
  set_idt_entry_fields(10, interrupt_stub_10, 0x28, 0x8E);
  set_idt_entry_fields(11, interrupt_stub_11, 0x28, 0x8E);
  set_idt_entry_fields(12, interrupt_stub_12, 0x28, 0x8E);
  set_idt_entry_fields(13, interrupt_stub_13, 0x28, 0x8E);
  set_idt_entry_fields(14, interrupt_stub_14, 0x28, 0x8E);
  set_idt_entry_fields(15, interrupt_stub_15, 0x28, 0x8E);
  set_idt_entry_fields(16, interrupt_stub_16, 0x28, 0x8E);
  set_idt_entry_fields(17, interrupt_stub_17, 0x28, 0x8E);
  set_idt_entry_fields(18, interrupt_stub_18, 0x28, 0x8E);
  set_idt_entry_fields(19, interrupt_stub_19, 0x28, 0x8E);
  set_idt_entry_fields(20, interrupt_stub_20, 0x28, 0x8E);
  set_idt_entry_fields(21, interrupt_stub_21, 0x28, 0x8E);
  set_idt_entry_fields(22, interrupt_stub_22, 0x28, 0x8E);
  set_idt_entry_fields(23, interrupt_stub_23, 0x28, 0x8E);
  set_idt_entry_fields(24, interrupt_stub_24, 0x28, 0x8E);
  set_idt_entry_fields(25, interrupt_stub_25, 0x28, 0x8E);
  set_idt_entry_fields(26, interrupt_stub_26, 0x28, 0x8E);
  set_idt_entry_fields(27, interrupt_stub_27, 0x28, 0x8E);
  set_idt_entry_fields(28, interrupt_stub_28, 0x28, 0x8E);
  set_idt_entry_fields(29, interrupt_stub_29, 0x28, 0x8E);
  set_idt_entry_fields(30, interrupt_stub_30, 0x28, 0x8E);
  set_idt_entry_fields(31, interrupt_stub_31, 0x28, 0x8E);
  set_idt_entry_fields(32, interrupt_stub_32, 0x28, 0x8E);
  set_idt_entry_fields(33, interrupt_stub_33, 0x28, 0x8E);
  set_idt_entry_fields(34, interrupt_stub_34, 0x28, 0x8E);
  set_idt_entry_fields(35, interrupt_stub_35, 0x28, 0x8E);
  set_idt_entry_fields(36, interrupt_stub_36, 0x28, 0x8E);
  set_idt_entry_fields(37, interrupt_stub_37, 0x28, 0x8E);
  set_idt_entry_fields(38, interrupt_stub_38, 0x28, 0x8E);
  set_idt_entry_fields(39, interrupt_stub_39, 0x28, 0x8E);
  set_idt_entry_fields(40, interrupt_stub_40, 0x28, 0x8E);
  set_idt_entry_fields(41, interrupt_stub_41, 0x28, 0x8E);
  set_idt_entry_fields(42, interrupt_stub_42, 0x28, 0x8E);
  set_idt_entry_fields(43, interrupt_stub_43, 0x28, 0x8E);
  set_idt_entry_fields(44, interrupt_stub_44, 0x28, 0x8E);
  set_idt_entry_fields(45, interrupt_stub_45, 0x28, 0x8E);
  set_idt_entry_fields(46, interrupt_stub_46, 0x28, 0x8E);
  set_idt_entry_fields(47, interrupt_stub_47, 0x28, 0x8E);
  set_idt_entry_fields(48, interrupt_stub_48, 0x28, 0x8E);
  set_idt_entry_fields(49, interrupt_stub_49, 0x28, 0x8E);
  set_idt_entry_fields(50, interrupt_stub_50, 0x28, 0x8E);
  set_idt_entry_fields(51, interrupt_stub_51, 0x28, 0x8E);
  set_idt_entry_fields(52, interrupt_stub_52, 0x28, 0x8E);
  set_idt_entry_fields(53, interrupt_stub_53, 0x28, 0x8E);
  set_idt_entry_fields(54, interrupt_stub_54, 0x28, 0x8E);
  set_idt_entry_fields(55, interrupt_stub_55, 0x28, 0x8E);
  set_idt_entry_fields(56, interrupt_stub_56, 0x28, 0x8E);
  set_idt_entry_fields(57, interrupt_stub_57, 0x28, 0x8E);
  set_idt_entry_fields(58, interrupt_stub_58, 0x28, 0x8E);
  set_idt_entry_fields(59, interrupt_stub_59, 0x28, 0x8E);
  set_idt_entry_fields(60, interrupt_stub_60, 0x28, 0x8E);
  set_idt_entry_fields(61, interrupt_stub_61, 0x28, 0x8E);
  set_idt_entry_fields(62, interrupt_stub_62, 0x28, 0x8E);
  set_idt_entry_fields(63, interrupt_stub_63, 0x28, 0x8E);
  set_idt_entry_fields(64, interrupt_stub_64, 0x28, 0x8E);
  set_idt_entry_fields(65, interrupt_stub_65, 0x28, 0x8E);
  set_idt_entry_fields(66, interrupt_stub_66, 0x28, 0x8E);
  set_idt_entry_fields(67, interrupt_stub_67, 0x28, 0x8E);
  set_idt_entry_fields(68, interrupt_stub_68, 0x28, 0x8E);
  set_idt_entry_fields(69, interrupt_stub_69, 0x28, 0x8E);
  set_idt_entry_fields(70, interrupt_stub_70, 0x28, 0x8E);
  set_idt_entry_fields(71, interrupt_stub_71, 0x28, 0x8E);
  set_idt_entry_fields(72, interrupt_stub_72, 0x28, 0x8E);
  set_idt_entry_fields(73, interrupt_stub_73, 0x28, 0x8E);
  set_idt_entry_fields(74, interrupt_stub_74, 0x28, 0x8E);
  set_idt_entry_fields(75, interrupt_stub_75, 0x28, 0x8E);
  set_idt_entry_fields(76, interrupt_stub_76, 0x28, 0x8E);
  set_idt_entry_fields(77, interrupt_stub_77, 0x28, 0x8E);
  set_idt_entry_fields(78, interrupt_stub_78, 0x28, 0x8E);
  set_idt_entry_fields(79, interrupt_stub_79, 0x28, 0x8E);
  set_idt_entry_fields(80, interrupt_stub_80, 0x28, 0x8E);
  set_idt_entry_fields(81, interrupt_stub_81, 0x28, 0x8E);
  set_idt_entry_fields(82, interrupt_stub_82, 0x28, 0x8E);
  set_idt_entry_fields(83, interrupt_stub_83, 0x28, 0x8E);
  set_idt_entry_fields(84, interrupt_stub_84, 0x28, 0x8E);
  set_idt_entry_fields(85, interrupt_stub_85, 0x28, 0x8E);
  set_idt_entry_fields(86, interrupt_stub_86, 0x28, 0x8E);
  set_idt_entry_fields(87, interrupt_stub_87, 0x28, 0x8E);
  set_idt_entry_fields(88, interrupt_stub_88, 0x28, 0x8E);
  set_idt_entry_fields(89, interrupt_stub_89, 0x28, 0x8E);
  set_idt_entry_fields(90, interrupt_stub_90, 0x28, 0x8E);
  set_idt_entry_fields(91, interrupt_stub_91, 0x28, 0x8E);
  set_idt_entry_fields(92, interrupt_stub_92, 0x28, 0x8E);
  set_idt_entry_fields(93, interrupt_stub_93, 0x28, 0x8E);
  set_idt_entry_fields(94, interrupt_stub_94, 0x28, 0x8E);
  set_idt_entry_fields(95, interrupt_stub_95, 0x28, 0x8E);
  set_idt_entry_fields(96, interrupt_stub_96, 0x28, 0x8E);
  set_idt_entry_fields(97, interrupt_stub_97, 0x28, 0x8E);
  set_idt_entry_fields(98, interrupt_stub_98, 0x28, 0x8E);
  set_idt_entry_fields(99, interrupt_stub_99, 0x28, 0x8E);
  set_idt_entry_fields(100, interrupt_stub_100, 0x28, 0x8E);
  set_idt_entry_fields(101, interrupt_stub_101, 0x28, 0x8E);
  set_idt_entry_fields(102, interrupt_stub_102, 0x28, 0x8E);
  set_idt_entry_fields(103, interrupt_stub_103, 0x28, 0x8E);
  set_idt_entry_fields(104, interrupt_stub_104, 0x28, 0x8E);
  set_idt_entry_fields(105, interrupt_stub_105, 0x28, 0x8E);
  set_idt_entry_fields(106, interrupt_stub_106, 0x28, 0x8E);
  set_idt_entry_fields(107, interrupt_stub_107, 0x28, 0x8E);
  set_idt_entry_fields(108, interrupt_stub_108, 0x28, 0x8E);
  set_idt_entry_fields(109, interrupt_stub_109, 0x28, 0x8E);
  set_idt_entry_fields(110, interrupt_stub_110, 0x28, 0x8E);
  set_idt_entry_fields(111, interrupt_stub_111, 0x28, 0x8E);
  set_idt_entry_fields(112, interrupt_stub_112, 0x28, 0x8E);
  set_idt_entry_fields(113, interrupt_stub_113, 0x28, 0x8E);
  set_idt_entry_fields(114, interrupt_stub_114, 0x28, 0x8E);
  set_idt_entry_fields(115, interrupt_stub_115, 0x28, 0x8E);
  set_idt_entry_fields(116, interrupt_stub_116, 0x28, 0x8E);
  set_idt_entry_fields(117, interrupt_stub_117, 0x28, 0x8E);
  set_idt_entry_fields(118, interrupt_stub_118, 0x28, 0x8E);
  set_idt_entry_fields(119, interrupt_stub_119, 0x28, 0x8E);
  set_idt_entry_fields(120, interrupt_stub_120, 0x28, 0x8E);
  set_idt_entry_fields(121, interrupt_stub_121, 0x28, 0x8E);
  set_idt_entry_fields(122, interrupt_stub_122, 0x28, 0x8E);
  set_idt_entry_fields(123, interrupt_stub_123, 0x28, 0x8E);
  set_idt_entry_fields(124, interrupt_stub_124, 0x28, 0x8E);
  set_idt_entry_fields(125, interrupt_stub_125, 0x28, 0x8E);
  set_idt_entry_fields(126, interrupt_stub_126, 0x28, 0x8E);
  set_idt_entry_fields(127, interrupt_stub_127, 0x28, 0x8E);
  set_idt_entry_fields(128, interrupt_stub_128, 0x28, 0x8E);
  set_idt_entry_fields(129, interrupt_stub_129, 0x28, 0x8E);
  set_idt_entry_fields(130, interrupt_stub_130, 0x28, 0x8E);
  set_idt_entry_fields(131, interrupt_stub_131, 0x28, 0x8E);
  set_idt_entry_fields(132, interrupt_stub_132, 0x28, 0x8E);
  set_idt_entry_fields(133, interrupt_stub_133, 0x28, 0x8E);
  set_idt_entry_fields(134, interrupt_stub_134, 0x28, 0x8E);
  set_idt_entry_fields(135, interrupt_stub_135, 0x28, 0x8E);
  set_idt_entry_fields(136, interrupt_stub_136, 0x28, 0x8E);
  set_idt_entry_fields(137, interrupt_stub_137, 0x28, 0x8E);
  set_idt_entry_fields(138, interrupt_stub_138, 0x28, 0x8E);
  set_idt_entry_fields(139, interrupt_stub_139, 0x28, 0x8E);
  set_idt_entry_fields(140, interrupt_stub_140, 0x28, 0x8E);
  set_idt_entry_fields(141, interrupt_stub_141, 0x28, 0x8E);
  set_idt_entry_fields(142, interrupt_stub_142, 0x28, 0x8E);
  set_idt_entry_fields(143, interrupt_stub_143, 0x28, 0x8E);
  set_idt_entry_fields(144, interrupt_stub_144, 0x28, 0x8E);
  set_idt_entry_fields(145, interrupt_stub_145, 0x28, 0x8E);
  set_idt_entry_fields(146, interrupt_stub_146, 0x28, 0x8E);
  set_idt_entry_fields(147, interrupt_stub_147, 0x28, 0x8E);
  set_idt_entry_fields(148, interrupt_stub_148, 0x28, 0x8E);
  set_idt_entry_fields(149, interrupt_stub_149, 0x28, 0x8E);
  set_idt_entry_fields(150, interrupt_stub_150, 0x28, 0x8E);
  set_idt_entry_fields(151, interrupt_stub_151, 0x28, 0x8E);
  set_idt_entry_fields(152, interrupt_stub_152, 0x28, 0x8E);
  set_idt_entry_fields(153, interrupt_stub_153, 0x28, 0x8E);
  set_idt_entry_fields(154, interrupt_stub_154, 0x28, 0x8E);
  set_idt_entry_fields(155, interrupt_stub_155, 0x28, 0x8E);
  set_idt_entry_fields(156, interrupt_stub_156, 0x28, 0x8E);
  set_idt_entry_fields(157, interrupt_stub_157, 0x28, 0x8E);
  set_idt_entry_fields(158, interrupt_stub_158, 0x28, 0x8E);
  set_idt_entry_fields(159, interrupt_stub_159, 0x28, 0x8E);
  set_idt_entry_fields(160, interrupt_stub_160, 0x28, 0x8E);
  set_idt_entry_fields(161, interrupt_stub_161, 0x28, 0x8E);
  set_idt_entry_fields(162, interrupt_stub_162, 0x28, 0x8E);
  set_idt_entry_fields(163, interrupt_stub_163, 0x28, 0x8E);
  set_idt_entry_fields(164, interrupt_stub_164, 0x28, 0x8E);
  set_idt_entry_fields(165, interrupt_stub_165, 0x28, 0x8E);
  set_idt_entry_fields(166, interrupt_stub_166, 0x28, 0x8E);
  set_idt_entry_fields(167, interrupt_stub_167, 0x28, 0x8E);
  set_idt_entry_fields(168, interrupt_stub_168, 0x28, 0x8E);
  set_idt_entry_fields(169, interrupt_stub_169, 0x28, 0x8E);
  set_idt_entry_fields(170, interrupt_stub_170, 0x28, 0x8E);
  set_idt_entry_fields(171, interrupt_stub_171, 0x28, 0x8E);
  set_idt_entry_fields(172, interrupt_stub_172, 0x28, 0x8E);
  set_idt_entry_fields(173, interrupt_stub_173, 0x28, 0x8E);
  set_idt_entry_fields(174, interrupt_stub_174, 0x28, 0x8E);
  set_idt_entry_fields(175, interrupt_stub_175, 0x28, 0x8E);
  set_idt_entry_fields(176, interrupt_stub_176, 0x28, 0x8E);
  set_idt_entry_fields(177, interrupt_stub_177, 0x28, 0x8E);
  set_idt_entry_fields(178, interrupt_stub_178, 0x28, 0x8E);
  set_idt_entry_fields(179, interrupt_stub_179, 0x28, 0x8E);
  set_idt_entry_fields(180, interrupt_stub_180, 0x28, 0x8E);
  set_idt_entry_fields(181, interrupt_stub_181, 0x28, 0x8E);
  set_idt_entry_fields(182, interrupt_stub_182, 0x28, 0x8E);
  set_idt_entry_fields(183, interrupt_stub_183, 0x28, 0x8E);
  set_idt_entry_fields(184, interrupt_stub_184, 0x28, 0x8E);
  set_idt_entry_fields(185, interrupt_stub_185, 0x28, 0x8E);
  set_idt_entry_fields(186, interrupt_stub_186, 0x28, 0x8E);
  set_idt_entry_fields(187, interrupt_stub_187, 0x28, 0x8E);
  set_idt_entry_fields(188, interrupt_stub_188, 0x28, 0x8E);
  set_idt_entry_fields(189, interrupt_stub_189, 0x28, 0x8E);
  set_idt_entry_fields(190, interrupt_stub_190, 0x28, 0x8E);
  set_idt_entry_fields(191, interrupt_stub_191, 0x28, 0x8E);
  set_idt_entry_fields(192, interrupt_stub_192, 0x28, 0x8E);
  set_idt_entry_fields(193, interrupt_stub_193, 0x28, 0x8E);
  set_idt_entry_fields(194, interrupt_stub_194, 0x28, 0x8E);
  set_idt_entry_fields(195, interrupt_stub_195, 0x28, 0x8E);
  set_idt_entry_fields(196, interrupt_stub_196, 0x28, 0x8E);
  set_idt_entry_fields(197, interrupt_stub_197, 0x28, 0x8E);
  set_idt_entry_fields(198, interrupt_stub_198, 0x28, 0x8E);
  set_idt_entry_fields(199, interrupt_stub_199, 0x28, 0x8E);
  set_idt_entry_fields(200, interrupt_stub_200, 0x28, 0x8E);
  set_idt_entry_fields(201, interrupt_stub_201, 0x28, 0x8E);
  set_idt_entry_fields(202, interrupt_stub_202, 0x28, 0x8E);
  set_idt_entry_fields(203, interrupt_stub_203, 0x28, 0x8E);
  set_idt_entry_fields(204, interrupt_stub_204, 0x28, 0x8E);
  set_idt_entry_fields(205, interrupt_stub_205, 0x28, 0x8E);
  set_idt_entry_fields(206, interrupt_stub_206, 0x28, 0x8E);
  set_idt_entry_fields(207, interrupt_stub_207, 0x28, 0x8E);
  set_idt_entry_fields(208, interrupt_stub_208, 0x28, 0x8E);
  set_idt_entry_fields(209, interrupt_stub_209, 0x28, 0x8E);
  set_idt_entry_fields(210, interrupt_stub_210, 0x28, 0x8E);
  set_idt_entry_fields(211, interrupt_stub_211, 0x28, 0x8E);
  set_idt_entry_fields(212, interrupt_stub_212, 0x28, 0x8E);
  set_idt_entry_fields(213, interrupt_stub_213, 0x28, 0x8E);
  set_idt_entry_fields(214, interrupt_stub_214, 0x28, 0x8E);
  set_idt_entry_fields(215, interrupt_stub_215, 0x28, 0x8E);
  set_idt_entry_fields(216, interrupt_stub_216, 0x28, 0x8E);
  set_idt_entry_fields(217, interrupt_stub_217, 0x28, 0x8E);
  set_idt_entry_fields(218, interrupt_stub_218, 0x28, 0x8E);
  set_idt_entry_fields(219, interrupt_stub_219, 0x28, 0x8E);
  set_idt_entry_fields(220, interrupt_stub_220, 0x28, 0x8E);
  set_idt_entry_fields(221, interrupt_stub_221, 0x28, 0x8E);
  set_idt_entry_fields(222, interrupt_stub_222, 0x28, 0x8E);
  set_idt_entry_fields(223, interrupt_stub_223, 0x28, 0x8E);
  set_idt_entry_fields(224, interrupt_stub_224, 0x28, 0x8E);
  set_idt_entry_fields(225, interrupt_stub_225, 0x28, 0x8E);
  set_idt_entry_fields(226, interrupt_stub_226, 0x28, 0x8E);
  set_idt_entry_fields(227, interrupt_stub_227, 0x28, 0x8E);
  set_idt_entry_fields(228, interrupt_stub_228, 0x28, 0x8E);
  set_idt_entry_fields(229, interrupt_stub_229, 0x28, 0x8E);
  set_idt_entry_fields(230, interrupt_stub_230, 0x28, 0x8E);
  set_idt_entry_fields(231, interrupt_stub_231, 0x28, 0x8E);
  set_idt_entry_fields(232, interrupt_stub_232, 0x28, 0x8E);
  set_idt_entry_fields(233, interrupt_stub_233, 0x28, 0x8E);
  set_idt_entry_fields(234, interrupt_stub_234, 0x28, 0x8E);
  set_idt_entry_fields(235, interrupt_stub_235, 0x28, 0x8E);
  set_idt_entry_fields(236, interrupt_stub_236, 0x28, 0x8E);
  set_idt_entry_fields(237, interrupt_stub_237, 0x28, 0x8E);
  set_idt_entry_fields(238, interrupt_stub_238, 0x28, 0x8E);
  set_idt_entry_fields(239, interrupt_stub_239, 0x28, 0x8E);
  set_idt_entry_fields(240, interrupt_stub_240, 0x28, 0x8E);
  set_idt_entry_fields(241, interrupt_stub_241, 0x28, 0x8E);
  set_idt_entry_fields(242, interrupt_stub_242, 0x28, 0x8E);
  set_idt_entry_fields(243, interrupt_stub_243, 0x28, 0x8E);
  set_idt_entry_fields(244, interrupt_stub_244, 0x28, 0x8E);
  set_idt_entry_fields(245, interrupt_stub_245, 0x28, 0x8E);
  set_idt_entry_fields(246, interrupt_stub_246, 0x28, 0x8E);
  set_idt_entry_fields(247, interrupt_stub_247, 0x28, 0x8E);
  set_idt_entry_fields(248, interrupt_stub_248, 0x28, 0x8E);
  set_idt_entry_fields(249, interrupt_stub_249, 0x28, 0x8E);
  set_idt_entry_fields(250, interrupt_stub_250, 0x28, 0x8E);
  set_idt_entry_fields(251, interrupt_stub_251, 0x28, 0x8E);
  set_idt_entry_fields(252, interrupt_stub_252, 0x28, 0x8E);
  set_idt_entry_fields(253, interrupt_stub_253, 0x28, 0x8E);
  set_idt_entry_fields(254, interrupt_stub_254, 0x28, 0x8E);
  set_idt_entry_fields(255, interrupt_stub_255, 0x28, 0x8E);
}

void set_handler(uint8_t vector, handler fn)
{
  handlers[vector] = fn;
}
} // namespace isr
} // namespace low_level

namespace
{
void set_idt_entry_fields(uint8_t vector, void (*stub)(), uint16_t code_segment,
                          uint8_t attributes)
{
  auto addr       = reinterpret_cast<virtual_address>(stub);
  auto ent        = &idt[vector];
  ent->offset_low = addr & 0xFFFF;
  ent->offset_hi  = addr >> 16;
  ent->cs         = code_segment;
  ent->type       = attributes;
}
} // namespace
